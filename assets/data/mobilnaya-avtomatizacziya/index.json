{"hash":"7ce6058f470c3851afaa44882541a7f3d1089ffc","data":{"post":{"title":"Мобильная автоматизация","content":"\n## Сложности мобильной автоматизации\n\nОсновные сложности при автоматизации тестирования мобильных приложений:\n\n1. существует несколько платформ: Android, iOs;\n2. у Android есть разные лаунчеры, обертки, которые также хотелось бы покрыть;\n3. сложный деплой, сложнее чем на вебе, тк прежде чем запустить тесты нужно собрать билды (их нужно где то собирать и как то передавать в тесты).\nТакже сложные хот фиксы, их не так просто сделать  как в вебе, например, нужно проходить процесс ревью перед заливом в маркет;\n4. сложность в масштабировании (параллелизации и многопоточном запуске), т. к. используется много ресурсов для запуска мобильных тестов( и для эмуляторов, и для реальных устройств)\nзапустить всё во много потоков не так просто и дорого;\n5. дорогостоящая инфраструктура - есть простой вариант, использование cloud ферм для запуска тестов, но цена у них очень высокая. А для запуска на реальном железе - для iOs нужны Mac устройства, \nс хорошими ресурсами и это тоже дорого.\n6. нестабильные тесты - т.к. в моб приложении ограниченная зона видимости, мы видим только те элементы, которые отображаются на экране. Могут быть разнообразные popup, push сообщения, нотификации, которые перекрывают элементы.\n\nОднако, в автоматизации моб приложений мы используем тот же паттерн Page Objects, Selenium под капотом и тот же подход к написанию тестов (Arrange(подготавливаем данные) - Act(выполняем действие) - Assert(проверяем)).\n\n## Инструменты для мобильной автоматизации\n\n|                       |Appium     |Espresso         |XCUITest   |Detox     |Selendroid|\n|-----------------------|-----------|-----------------|-----------|----------|----------|\n|**iOS**                |+          |-                |+          |+         |+         |\n|**Android**            |+          |+                |-          |+         |+         |\n|**Type**               |Balck box  |White box        |Black box  |Grey box  |Black box |\n|**Programming Lang**   |Almost any |Kotlin           |Swift      |JavaScript|Java      |\n|**Cost**               |Free       |Free             |Free       |Free      |Free      |\n|**Community**          |Very active|Google           |Apple      |Wix       |Average   |\n|**Speed**              |Slow       |Fast             |Fast       |Fast      |Slow      |\n|**Web, native, hybrid**| +         |Hybrid and native|Only native|Only      |+         |\n\n\nSelendroid - достаточно старый инструмент, используется скорее теми компаниями которые взяли его еще давно, неизвестно поддерживается ли он на текущий день.\n\nDetox - подходит только для приложений на react native, нативные моб приложения им не получится автоматизировать.\n\nEspresso, XCUITest - нативные инструменты, заточные под свою платформу.\n\n\n## Преимущества Appium\n\n1. Возможность писать кросс платформенные тесты. \nНаписав один раз тест под одну платформу, нужно минимальное количество действий чтобы адаптировать его под другую (добавить соответсвующие локаторы и обработать индивидуальные особенности платформы);\n2. Позволяет писать тесты на практически любом языке программирования;\n3. Нет необходимости модифицировать код приложения. Appium - полный Black box и нам ненужно модифицировать код самого приложения;\n4. Работает на основе Selenium JSON wire protocol;\n5. Open source фреймворк с активным комьюнити. Спонсируется souce lab которая также предоставляет cloud решения;\n6. Поддержка параллельного запуска используя Selenium Grid;\n\n## Архитектура Appium\n\nAppium - это http сервер.\n\nУ нас есть тестовый скрипт, мы передаем его в Appium и Appium транслирует его на мобильные устройства, с помощью json wire protocol. \n\nAppium - это обертка над теми же нативными инструментами(XCUITest и UIAutomator, Expresso), т.к. он все свои команды дальше ретранслирует в команды понятные нативным инструментам.\n\nДля iOS используется XCUITest, для Android можно выбрать между UIAutomator и Expresso. \n\nДля Expresso добавили поддержку примерно в 2020 г, он на 20% быстрее, чем UIAutomator. Плюс Expresso делает Appium немного Grey box'ом, потому что есть возможность сделать backdoor к приложению и в целом делает немного более открытым код приложения.\n\nJSONWP(JSON wire protocol) - механизм, созданный командой разработчиков WebDriver. Этот протокол представляет собой набор четко определенных стандартизированных endpoints, открытых через RESTfull API.\n\n`AppiumDriver.getPageSource();` - этот метод вызовет HTTP-запрос, и получит ответ от API. Назад вернется page source в формате строки.\n\n`/session/:sessionId/source` - эндпоинт, который обрабатывает метод getPageSource.\n\n\n## Appium + Android\n\nAppium работает с Android через Espresso и UIAutomator. Поддерживается Google.\nEspresso быстрее чем UIAutomator. \n\n## Appium + iOS\n\nНесколько лет назад под капотом использовался не XCUITests, а другой фреймворк. Но Apple решила прекратить его поддержку и выпустила XCUITests. А XCUITests на тот момент противоречил философии Appium, в том что нам не нужно модифицировать код, т.к. XCUITests нужно было собирать вместе с приложением. \n\nИ некоторое время, Appium нельзя было использовать для iOS приложений. На помощь пришел Facebook и сделал WebDriverAgent Server. При запуске тестов на Appium'e на моб устройство также ставится WebDriverAgent и он транслирует команды от Appium к XCUITests.\n\n## Способы запуска\n\n- на реальных устройствах;\n\nЭто самый надежный вариант. Но построить свою ферму дорого и сложно поддерживать, тк устройства всегда были подключены к сети и нужно выполнять настройки, чтобы не всплывали всяки popup сообщения и если они всегда в сети, то нужно будет часто менять батарейку и собрать парк из разных девайсов будет дорого  и сложно.\n\n- на симуляторах/эмуляторах;\n\nОптимальный вариант. Не так много кейсов, которые репродьюсятся только на реальных устройствах. Они есть но их не много.\n\nдля iOS - используются симуляторы, на Android поднимаются эмуляторы. \n\nИспользуются стандартные эмуляторы, которые предоставляет Android Studio и симуляторы от XCode для iOS.\n\n- на cloud фермах \n    - Browser Stack (2 параллельных запуска ~ 400$ в месяц, 5 параллельных запусков ~ 1000$ в месяц)\n    - Sauce Labs\n    - AWS Device Farm\n    \nСамые удобные, тк просто указываем url на хост в ферме и запускаем. Но это очень дорого, плюс вопрос к секьюрности для запусков тестов. \n\n## Запуск тестов\n\n- для iOS\n\nПри запуске на реальном устройстве:\n1. собираем .ipa файл, подписанный сертификатом организации\n2. берем девайс, добавленный в провижен организации\n3. используется аккаунт с сертификатом разработчика\n\nПри запуске на симуляторе просто собираем через XCode .app файл.\nНа симуляторе нельзя установить файл с расширением .ipa, потому что там другая архитектура и он там не запустится.\n\n- для Android\n\nСобираем apk через Gradle и Android Studio на эмулятор и на реальное устройство и можно работать.\n\n## Что нужно чтобы начать?\n\n### Android\n- JDK (Java Development Kit)\n- Android SDK\n- Appium\n\n### iOS\n- Mac OS\n- XCode\n- JDK (Java Development Kit)\n- Homebrew\n- Node and npm\n\nhttps://qa-automation.git-doc.evo.dev/mobile/ubuntu.html\n\n## Стек инструментов\n\n- Appium\n- Java/Kotlin\n- TestNg\n- Maven\n- Allure REport\n- AssertJ\n- Log4J\n\n## Инструменты чтобы находить локаторы\n\n### Android\n\n- UIAutomatorViewer (Android)\n- Appium Inspector - делает скриншот текущего экрана и показывает состояние выбранного элемента.\n\nМожно искать элементы по id и по xPath:\n\n- Id\n\nresource-id = id\n```java\n@AndroidFindBy(id = \"tvProSalePay\")\n```\n\n- xPath\n```java\n@AndroidFindBy(xpath = \"//android.widget.TextView[@text = 'XL']\")\n```\n\n### iOS\n\nМожно использовать только Appium Inspector, так как нет других инструментов для этой цели.\n\nМожно искать по id, iOSClassChain, iOS predicate string (в порядке снижения скорости). \n\nПо xPath тоже можно но крайне не рекомендуется так как это происходит очень медленно из за того что в iOS приложениях нет xml дерева и appium его вычисляет самостоятельно а на это тратится время.\n\n- Id\n```java\n@iOSXCUITFindBy(id=\"client name\")\n```\n\n- iOSClassChain\nАналог xPath.\n\n```java\n@iOSXCUITFindBy(iOSClassChain=\"**/XCUIElementTypeButton[`name == 'icRatingStar'`]\")\n```\n\n- iOS predicate string\n\nСвой тип локаторов.\n\n```java\nString selector = \"type == 'XCUIElementTypeButton' AND value BEGINSWITH[c] 'bla' AND visible == 1\"\n```\n\n## Боли Appium \n\n### Недоступные элементы\n\nНекоторые объекты не имеют выделенного элемента в DOM дереве и сложно с ними взаимодействовать отдельно, например взять текст. Встречается в сообщениях об ошибке, тост сообщениями, поп-апами.\n\n**Решение:**\n\n1. Можно использовать библиотеку tesseract - для распознавания текста на изображении.\n2. Клики по координатам.  \nЕсли нужно кликнуть на элемент, которого нет в дом дереве.  \nВ этом случае лучше брать не координаты этого элемента, а стараться брать соотношение по экрану (находить центр и т.д.), потому что если мы поменяем устройство, на котором будем прогонять и там расширение экрана другое, то мы столкнемся с трудностями.\n\n### Ограниченная зона видимости\n\nКогда мы делаем скриншот в Appium, мы видим дерево только тех элементов, которые есть сейчас на экране, то что вне мы не видим. \n\n**Решение:**\n\nДойти до элементов вне зоны видимости мы можем только проскролив.\n\n- iOS\n\n```java\nHashMap<String, String> scrollObject = new HashMap<>();\nscrollObject.put(\"element\", element.getId());\nscrollObject.put(\"toVisible\", \"true\");\n\ndriver.executeScript(\"mobile:scroll\", scrollObject);\n```\n\n- Android\n\n```java\nprotected void scrollToElementAndroid(String scrollableListId, String selectionText){\n    ((AndroidDriver) driver).findElementByAndroidUIAutomator(\"new UiScrollable(new UiSelector().scrollable(true)\"\n    + \".resourceId(\\\"\" + scrollableListId + \"\\\"))\"\n    + \".setAsHorizontalList().scrollIntoView(new UiSelector().text(\\\"\" + selectionText + \"\\\"))\").click();\n}\n```\n\n**Универсальный скролл**\n\n```java\npublic void swipeUpToFindElement(By by, int maxSwipes){\n    int alreadySwiped = 0;\n    while(driver.findElements(by).size() == 0){\n        if (alreadySwiped > maxSwipes){\n            waitForElementToBePresent(by, \"Невозможно найти элемент по свайпу\", Constants.SMALL_TIMEOUT);\n            return;\n        }\n        swipeUpQuick();\n        Log.info(\"Выполнен свайп\");\n        ++alreadySwiped;\n    }\n}\n```\n\n### Платформозависимость\n\nУ Android и iOS есть свои особенности.\n\n- Разные атрибуты у элементов\niOS - value, android - text\niOs - visible, android - displayed\niOS - enabled, android - checked, checkable, enabled\n\n- Различия в основных флоу приложения на Android и на iOS\n\n- Часто при работе с веб вью на разных версиях Android у элементов разный xPath\n\n```java\n@AndroidFindAll(\n\n)\n```\n\nwatch?v=zp0qC6JT0rE\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","description":"Мобильная автоматизация","image":"null","category":{"id":"mobile","title":"mobile","path":"/category/mobile/"},"date":"02/09/2022","path":"/mobilnaya-avtomatizacziya/","links":[{"title":"","items":[{"title":"Алгоритмы (курс Яндекс)","link":"/algoritmy-kurs-yandeks/"}]}],"headings":[{"value":"Сложности мобильной автоматизации","anchor":"#сложности-мобильной-автоматизации"},{"value":"Инструменты для мобильной автоматизации","anchor":"#инструменты-для-мобильной-автоматизации"},{"value":"Преимущества Appium","anchor":"#преимущества-appium"},{"value":"Архитектура Appium","anchor":"#архитектура-appium"},{"value":"Appium + Android","anchor":"#appium--android"},{"value":"Appium + iOS","anchor":"#appium--ios"},{"value":"Способы запуска","anchor":"#способы-запуска"},{"value":"Запуск тестов","anchor":"#запуск-тестов"},{"value":"Что нужно чтобы начать?","anchor":"#что-нужно-чтобы-начать"},{"value":"Стек инструментов","anchor":"#стек-инструментов"},{"value":"Инструменты чтобы находить локаторы","anchor":"#инструменты-чтобы-находить-локаторы"},{"value":"Боли Appium","anchor":"#боли-appium"}],"subtitles":[{"depth":2,"value":"Сложности мобильной автоматизации","anchor":"#сложности-мобильной-автоматизации"},{"depth":2,"value":"Инструменты для мобильной автоматизации","anchor":"#инструменты-для-мобильной-автоматизации"},{"depth":2,"value":"Преимущества Appium","anchor":"#преимущества-appium"},{"depth":2,"value":"Архитектура Appium","anchor":"#архитектура-appium"},{"depth":2,"value":"Appium + Android","anchor":"#appium--android"},{"depth":2,"value":"Appium + iOS","anchor":"#appium--ios"},{"depth":2,"value":"Способы запуска","anchor":"#способы-запуска"},{"depth":2,"value":"Запуск тестов","anchor":"#запуск-тестов"},{"depth":2,"value":"Что нужно чтобы начать?","anchor":"#что-нужно-чтобы-начать"},{"depth":3,"value":"Android","anchor":"#android"},{"depth":3,"value":"iOS","anchor":"#ios"},{"depth":2,"value":"Стек инструментов","anchor":"#стек-инструментов"},{"depth":2,"value":"Инструменты чтобы находить локаторы","anchor":"#инструменты-чтобы-находить-локаторы"},{"depth":3,"value":"Android","anchor":"#android-1"},{"depth":3,"value":"iOS","anchor":"#ios-1"},{"depth":2,"value":"Боли Appium","anchor":"#боли-appium"},{"depth":3,"value":"Недоступные элементы","anchor":"#недоступные-элементы"},{"depth":3,"value":"Ограниченная зона видимости","anchor":"#ограниченная-зона-видимости"},{"depth":3,"value":"Платформозависимость","anchor":"#платформозависимость"}],"tags":[{"id":"qa","title":"qa","path":"/tag/qa/"}]},"comments":{"edges":[]}},"context":{}}